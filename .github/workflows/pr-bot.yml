name: Smart PR Bot

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      # 1. Auto-Labeler based on paths
      - name: Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          sync-labels: true

      # 2. Size Labeler
      - name: Label based on size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const additions = pr.data.additions;
            const deletions = pr.data.deletions;
            const changes = additions + deletions;

            let sizeLabel = 'size/xs';
            if (changes >= 1000) sizeLabel = 'size/xl';
            else if (changes >= 500) sizeLabel = 'size/l';
            else if (changes >= 100) sizeLabel = 'size/m';
            else if (changes >= 10) sizeLabel = 'size/s';

            // Remove existing size labels
            const labelsToRemove = ['size/xs', 'size/s', 'size/m', 'size/l', 'size/xl'].filter(l => l !== sizeLabel);
            
            // Check current labels
            const currentLabels = pr.data.labels.map(l => l.name);
            
            // Remove old size labels
            for (const label of labelsToRemove) {
              if (currentLabels.includes(label)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              }
            }

            // Add new size label
            if (!currentLabels.includes(sizeLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [sizeLabel]
              });
            }

  welcome:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Welcome New Contributors
        uses: actions/github-script@v7
        with:
          script: |
            // Get list of PRs by this author
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: context.actor
            });

            // If this is their first PR (length is 1 because it includes the current one)
            if (prs.data.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "ðŸŽ‰ **Welcome to the Netra project!** \n\nThanks for opening your first Pull Request. Please make sure you've read our [Contributing Guidelines](https://github.com/fierypooja/Vortex/wiki/Contributing). \n\nA maintainer will review your changes shortly."
              });
            }
